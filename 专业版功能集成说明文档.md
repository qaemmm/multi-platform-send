# 专业版功能集成说明文档

## 核心模型与配置
- 用户订阅状态通过 `plan` 与 `planExpiredAt` 字段挂载在用户表，定义见 `src/lib/db/schema.ts:11`。
- 专业版功能矩阵集中在 `src/lib/subscription/config/features.ts:13`，描述功能归属、额度限制和升级提示；价格文案位于 `src/lib/subscription/config/features.ts:173`。

## 全局状态与前端守卫
- `UserPlanProvider` 在根布局包裹整个 App，负责拉取订阅与用量并暴露 `isPro`、`daysRemaining` 等状态（`src/lib/subscription/hooks/useUserPlan.ts:40`、`src/lib/subscription/hooks/useUserPlan.ts:114`）。
- `FeatureGuard` 及其语法糖（`PlatformGuard`、`StyleGuard`、`ArticleCreationGuard` 等）统一调用 `checkFeatureAccess` 控制渲染，并自动触发升级提示（`src/lib/subscription/components/FeatureGuard.tsx:15`、`src/lib/subscription/components/FeatureGuard.tsx:68`）。
- `UpgradePrompt` 会基于不同场景展示卡片、弹窗或行内提示，串联客服引导、兑换码弹窗及刷新逻辑（`src/lib/subscription/components/UpgradePrompt.tsx:18`、`src/lib/subscription/components/UpgradePrompt.tsx:37`、`src/lib/subscription/components/UpgradePrompt.tsx:97`）。
- 典型使用：仪表盘限制文章数量（`src/app/dashboard/page.tsx:38`、`src/app/dashboard/page.tsx:390`），新建页通过 `ArticleCreationGuard` 控制文章额度（`src/app/editor/new/page.tsx:8`），Markdown 编辑器在图片超配额时触发升级弹窗（`src/components/editor/multi-platform-editor.tsx:32`、`src/components/editor/multi-platform-editor.tsx:339`）。

## 后端接口与服务
- `/api/auth/user-plan`：基于登录态返回订阅状态和有效期（`src/app/api/auth/user-plan/route.ts:9`）。
- `/api/redeem`：校验并消费兑换码，按时长延长 `planExpiredAt`（`src/app/api/redeem/route.ts:9`）。
- `/api/admin/redeem-codes`：管理员批量生成/查看兑换码，管理员邮箱来源于 `ADMIN_EMAILS`（`src/app/api/admin/redeem-codes/route.ts:10`、`src/app/api/admin/redeem-codes/route.ts:24`）。
- 图片上传统一调用 `uploadImageToR2` 与 `checkImageQuota`，先验证额度再上传，超限时返回 `upgradeRequired`（`src/lib/services/image-service.ts:104`、`src/lib/services/image-service.ts:235`）。前端通过 `useImageUploadService` 做本地权限探测（`src/lib/services/imageUploadService.ts:29`、`src/lib/services/imageUploadService.ts:39`）。

## 兑换与客服链路
- 升级路径以“客服二维码 → 兑换码 → 站内兑换”为主：客服弹窗在 `src/components/ui/wechat-guide-dialog.tsx:11`，兑换码弹窗在 `src/components/ui/redeem-code-dialog.tsx:12`，全局浮窗按钮在 `src/components/ui/customer-support-button.tsx:19`。
- 数据表 `redeem_codes`、`image_usage_stats` 分别存储兑换码及图片用量（`src/lib/db/schema.ts:69`、`src/lib/db/schema.ts:83`）；脚本示例见 `fix-user-plan.js:12`。

## 环境配置要点
- `.env.example` 展示数据库、Cloudflare R2、七牛、OpenAI、Stripe 等占位变量；部署时需补齐 `ADMIN_EMAILS`、客服微信号、支付/通知相关配置。

## 在其他项目复用的建议流程
1. 建立用户订阅字段、兑换码表、用量统计表。
2. 引入 `UserPlanProvider` 或等价全局上下文，保持 `isPro`/用量的实时刷新。
3. 复制并调整 `FEATURES`、`UPGRADE_PROMPTS`，维护功能矩阵与升级文案。
4. 接入 `/api/auth/user-plan`、`/api/redeem` 等接口，并在关键业务接口里调用配额校验与记录逻辑。
5. 在界面层通过 `FeatureGuard` 包裹敏感功能，并植入升级提示及客服通道。
6. 若采用自动支付，只需在支付成功回调中更新 `plan` 与 `planExpiredAt`，其他流程保持不变。

## 快速落地提示
- 保留现有“客服 + 兑换码”流程即可上线专业版；云存储和数据库迁移完成后即可实用。
- 新项目移植时优先搬运 `src/lib/subscription/*`、`src/lib/services/image-service.ts`、相关 API 路由及 UI 弹窗，按需裁剪样式或功能。
- 若需要自动扣费，新增支付回调并复用兑换码逻辑中的订阅更新片段即可。

## 升级流程图
```mermaid
flowchart TD
    A[用户触达功能受限\nFeatureGuard 拦截] --> B{UpgradePrompt 展示方案}
    B -->|点击客服按钮| C[WechatGuideDialog\n展示二维码/客服微信]
    C -->|添加客服&获取兑换码| D[用户输入兑换码\nRedeemCodeDialog]
    D -->|POST /api/redeem| E{兑换码有效?}
    E -->|否| F[返回错误\n提示重新获取]
    E -->|是| G[写入 users.plan='pro'\n更新 planExpiredAt]
    G --> H[刷新 useUserPlan\nrefreshPlan()/refreshUsage()]
    H --> I[重试功能\nFeatureGuard 放行]
```

## 支付方案建议
1. **延续兑换码模式（现状）**  
   - 适用于轻量商业化或需人工审核的场景。  
   - 建议在管理后台补充批量导出/失效控制，以及客服脚本模板，提升运营效率。

2. **半自动支付（第三方收款 + 兑换码自动发放）**  
   - 接入微信/支付宝/Stripe Checkout 等支付页面，支付成功后通过 Webhook 触发兑换码生成与邮件/站内信发送。  
   - 仍以兑换码写入订阅，能与现有逻辑无缝衔接；需新增 Webhook 校验与“已发码”审计。

3. **全自动订阅扣费**  
   - 在支付成功回调中直接调用内部服务更新 `users.plan` 和 `planExpiredAt`，并记录订单号、流水。  
   - 建议拆分 `SubscriptionService` 统一处理：订单校验 → 订阅更新 → 额度同步，确保和前端 `useUserPlan` 的刷新流程一致。  
   - 需关注退款/续费/降级等边界，结合支付平台提供的 Webhook 事件完成状态同步。

> 无论选择哪种方案，都需要保证：支付成功回调成功写入订阅信息、日志可追溯、并在失败时具备人工补偿手段。
